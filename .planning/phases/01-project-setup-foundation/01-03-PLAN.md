---
phase: 01-project-setup-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - Dockerfile
  - .dockerignore
  - docker-compose.yml
  - eslint.config.js
  - .prettierrc
  - .prettierignore
autonomous: false

must_haves:
  truths:
    - "Docker image builds successfully from multi-stage Dockerfile"
    - "Docker container starts and serves both API and static client"
    - "Health check works inside Docker container"
    - "ESLint runs without errors across all packages"
    - "Prettier formats all source files consistently"
    - "Production build (tsc --build + vite build) succeeds inside Docker"
  artifacts:
    - path: "Dockerfile"
      provides: "Multi-stage Docker build for production deployment"
      contains: "FROM.*AS builder"
      min_lines: 25
    - path: ".dockerignore"
      provides: "Docker build exclusions"
      contains: "node_modules"
    - path: "eslint.config.js"
      provides: "Root ESLint flat config for monorepo"
      min_lines: 20
    - path: ".prettierrc"
      provides: "Prettier configuration"
    - path: "docker-compose.yml"
      provides: "Local Docker dev convenience"
      contains: "services"
  key_links:
    - from: "Dockerfile"
      to: "packages/server/dist/index.js"
      via: "CMD node packages/server/dist/index.js"
      pattern: "CMD.*node.*server.*dist"
    - from: "Dockerfile"
      to: "packages/client/dist"
      via: "COPY client build output for static serving"
      pattern: "COPY.*client/dist"
    - from: "eslint.config.js"
      to: "packages/client/src"
      via: "ESLint TypeScript parser for client code"
      pattern: "typescript-eslint|@typescript-eslint"
    - from: "eslint.config.js"
      to: "packages/server/src"
      via: "ESLint TypeScript parser for server code"
      pattern: "typescript-eslint|@typescript-eslint"
---

<objective>
Create the Docker containerization setup (multi-stage Dockerfile, docker-compose), ESLint flat config, and Prettier configuration. Verify the complete project with a human checkpoint.

Purpose: Makes the project deployable to Digital Ocean (containerized) and enforces code quality standards across all packages. The checkpoint confirms the full-stack skeleton works end-to-end before proceeding to Phase 2.

Output: Production-ready Dockerfile, consistent linting/formatting, and human-verified working project.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-project-setup-foundation/01-CONTEXT.md
@.planning/phases/01-project-setup-foundation/01-RESEARCH.md
@.planning/phases/01-project-setup-foundation/01-01-SUMMARY.md
@.planning/phases/01-project-setup-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Docker multi-stage build, ESLint, and Prettier configuration</name>
  <files>
    Dockerfile
    .dockerignore
    docker-compose.yml
    eslint.config.js
    .prettierrc
    .prettierignore
  </files>
  <action>
    Create Dockerfile (multi-stage, per user decision and research Pattern 6):

    Stage 1 - builder:
    - FROM node:22-alpine AS builder
    - WORKDIR /app
    - Copy package*.json files (root + all three packages) FIRST for layer caching
    - RUN npm ci (install all deps including devDependencies)
    - Copy tsconfig.json (root), packages/ source code
    - RUN npm run build (tsc --build for TS, then vite build for client)
    - The build script in root package.json should chain: "build": "tsc --build && npm run build -w @repo/client"
    - Ensure root package.json build script does: tsc --build (compiles shared + server) then npm run build -w @repo/client (vite build)

    Stage 2 - production:
    - FROM node:22-alpine AS production
    - WORKDIR /app
    - Copy package*.json files (root + all three packages)
    - RUN npm ci --omit=dev (production deps only)
    - COPY --from=builder /app/packages/server/dist ./packages/server/dist
    - COPY --from=builder /app/packages/shared/dist ./packages/shared/dist
    - COPY --from=builder /app/packages/client/dist ./packages/client/dist
    - RUN addgroup -g 1001 -S nodejs && adduser -S nodejs -u 1001
    - USER nodejs
    - EXPOSE 3000
    - ENV NODE_ENV=production
    - HEALTHCHECK --interval=30s --timeout=3s CMD wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1
    - CMD ["node", "packages/server/dist/index.js"]

    Create .dockerignore:
    - node_modules, .git, .gitignore, .vscode, .idea, *.md, .env, .env.local, Dockerfile, docker-compose.yml, *.log, coverage/, dist/, build/, .planning/

    Create docker-compose.yml (convenience for local Docker testing):
    - Service "app": build from ., ports 3000:3000, env_file packages/server/.env, restart unless-stopped

    Create eslint.config.js (ESLint v9 flat config):
    - Install devDependencies at root: eslint (^9.x), @typescript-eslint/parser (^8.x), @typescript-eslint/eslint-plugin (^8.x), eslint-config-prettier (^9.x), eslint-plugin-react (latest), eslint-plugin-react-hooks (latest)
    - Use typescript-eslint flat config helper (tseslint.config)
    - Global ignores: ["**/dist/**", "**/node_modules/**", "**/coverage/**"]
    - Base config: recommended + typescript-eslint recommended + prettier (to disable formatting rules)
    - Client-specific overrides (packages/client/src/**): enable react and react-hooks plugins, set react version to "detect"
    - Server-specific overrides (packages/server/src/**): node-specific rules if needed
    - Rules: no-console: "warn" (not error, useful in server), @typescript-eslint/no-unused-vars: ["error", { argsIgnorePattern: "^_" }]

    Create .prettierrc:
    - semi: true, singleQuote: true, trailingComma: "all", printWidth: 100, tabWidth: 2, arrowParens: "always"

    Create .prettierignore:
    - dist, node_modules, coverage, package-lock.json, *.md

    Install all new root devDependencies.

    Update root package.json scripts:
    - "lint": "eslint packages/*/src/**/*.{ts,tsx}"
    - "lint:fix": "eslint packages/*/src/**/*.{ts,tsx} --fix"
    - "format": "prettier --write packages/*/src/**/*.{ts,tsx,css}"
    - "format:check": "prettier --check packages/*/src/**/*.{ts,tsx,css}"
    - "build": "tsc --build && npm run build -w @repo/client" (chain TS + Vite builds)

    Run `npm run lint` -- fix any issues found.
    Run `npm run format` -- format all files.
    Run `npm run build` -- verify full build chain succeeds.
    Run `docker build -t hapyy-portal .` -- verify Docker image builds.
    Run `docker run --rm -p 3001:3000 hapyy-portal` -- verify container starts and health check works.
    Curl http://localhost:3001/api/health -- verify response.
    Stop container after verification.
  </action>
  <verify>
    1. `npm run lint` passes with no errors.
    2. `npm run format:check` passes (all files formatted).
    3. `npm run build` succeeds (tsc + vite).
    4. `docker build -t hapyy-portal .` completes successfully.
    5. `docker run --rm -p 3001:3000 hapyy-portal` -- container starts, `curl http://localhost:3001/api/health` returns JSON.
    6. Stop the Docker container.
  </verify>
  <done>
    Multi-stage Docker build produces working production image. ESLint and Prettier enforce consistent code quality across all packages. Full build chain (TypeScript + Vite + Docker) succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 1 setup</name>
  <files>
    (no files -- human verification only)
  </files>
  <action>
    Human verifies the complete Phase 1 setup works end-to-end. This checkpoint covers:
    - Complete TypeScript monorepo with npm workspaces (3 packages: client, server, shared)
    - Express server with health endpoint and error handling (INFRA-04)
    - React client with Vite, Tailwind CSS, shadcn/ui, Redux Toolkit + RTK Query, React Router, dark/light theme toggle
    - Single-port development via Vite middleware in Express
    - Multi-stage Docker containerization
    - ESLint + Prettier code quality enforcement

    Steps for human to verify:
    1. Run `npm run dev` from project root
    2. Open http://localhost:3000 in browser
    3. Verify: React app renders with "Hapyy Languages Web Portal" heading
    4. Verify: Health status indicator shows "Connected" (green) -- proves RTK Query fetches /api/health
    5. Verify: Click theme toggle button -- page switches between dark and light mode
    6. Verify: Tailwind styling is applied (fonts, colors, spacing look polished, not unstyled HTML)
    7. Open http://localhost:3000/api/health -- verify JSON response with status, uptime, environment
    8. Open browser DevTools Console -- no errors
    9. Stop dev server (Ctrl+C)
    10. Run `npm test` -- verify all tests pass
    11. Run `npm run lint` -- verify no lint errors
    12. Optionally: Run `docker build -t hapyy-portal . && docker run --rm -p 3001:3000 hapyy-portal` to verify Docker build
  </action>
  <verify>
    Human confirms all 12 verification steps pass. Type "approved" to proceed to Phase 2, or describe any issues.
  </verify>
  <done>
    Human has approved the complete Phase 1 setup. All success criteria met: TypeScript compiles, Express health check works, env vars load, Docker containerization works, error handling distinguishes user vs system errors (INFRA-04).
  </done>
</task>

</tasks>

<verification>
- Docker image builds and runs successfully
- ESLint passes across all packages
- Prettier formatting is consistent
- Full Phase 1 success criteria met:
  1. TypeScript full-stack project compiles without errors (tsc --build)
  2. Express server responds to health check endpoint (/api/health)
  3. Environment variables load correctly from configuration
  4. Project can be containerized for Digital Ocean deployment (Dockerfile)
  5. Clear error messages distinguish user errors from system errors (INFRA-04)
</verification>

<success_criteria>
- Docker multi-stage build produces <200MB production image
- Container starts and serves both API and static client
- Health check works via Docker HEALTHCHECK and curl
- ESLint flat config catches TypeScript issues in all packages
- Prettier formats consistently (no diff on format:check)
- Human verifies: dev server works, theme toggle works, health indicator works, styling looks right
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup-foundation/01-03-SUMMARY.md`
</output>
