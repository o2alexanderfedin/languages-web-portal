---
phase: 02-file-upload-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/types/upload.ts
  - packages/shared/src/types/index.ts
  - packages/server/src/services/projectService.ts
  - packages/server/src/utils/pathSecurity.ts
  - packages/server/src/utils/fileValidation.ts
  - packages/server/src/middleware/fileUpload.ts
  - packages/server/src/middleware/zipValidation.ts
  - packages/server/src/routes/upload.ts
  - packages/server/src/index.ts
  - packages/server/src/config/env.ts
  - packages/server/package.json
  - packages/server/src/__tests__/projectService.test.ts
  - packages/server/src/__tests__/pathSecurity.test.ts
  - packages/server/src/__tests__/fileValidation.test.ts
  - packages/server/src/__tests__/upload.test.ts
autonomous: true

must_haves:
  truths:
    - "Server extracts uploaded ZIP into isolated UUID-based project directory"
    - "Server rejects malicious archives (zip bombs, path traversal, symlinks) with clear error messages"
    - "Each client session gets isolated project directory that prevents cross-contamination"
    - "Server validates ZIP MIME type via magic bytes, not just client-provided content-type"
    - "Upload endpoint returns projectId for subsequent operations"
  artifacts:
    - path: "packages/shared/src/types/upload.ts"
      provides: "Upload request/response type contracts shared between client and server"
      exports: ["UploadResponse", "UploadConfig", "MAX_UPLOAD_SIZE"]
    - path: "packages/server/src/services/projectService.ts"
      provides: "UUID-based isolated project directory creation and cleanup"
      exports: ["ProjectService"]
    - path: "packages/server/src/utils/pathSecurity.ts"
      provides: "Path traversal and symlink detection utilities"
      exports: ["validatePathSafety"]
    - path: "packages/server/src/utils/fileValidation.ts"
      provides: "Magic bytes MIME type verification"
      exports: ["verifyFileMimeType"]
    - path: "packages/server/src/middleware/fileUpload.ts"
      provides: "Multer middleware configured with size/type limits"
      exports: ["uploadMiddleware"]
    - path: "packages/server/src/middleware/zipValidation.ts"
      provides: "Pompelmi ZIP security validation middleware"
      exports: ["zipValidator"]
    - path: "packages/server/src/routes/upload.ts"
      provides: "POST /api/upload endpoint with full validation pipeline"
      exports: ["default (Router)"]
  key_links:
    - from: "packages/server/src/routes/upload.ts"
      to: "packages/server/src/middleware/fileUpload.ts"
      via: "multer middleware in route chain"
      pattern: "upload\\.single"
    - from: "packages/server/src/routes/upload.ts"
      to: "packages/server/src/middleware/zipValidation.ts"
      via: "pompelmi middleware after multer"
      pattern: "zipValidator"
    - from: "packages/server/src/routes/upload.ts"
      to: "packages/server/src/services/projectService.ts"
      via: "creates isolated directory for extraction"
      pattern: "projectService\\.createProjectDir"
    - from: "packages/server/src/routes/upload.ts"
      to: "packages/server/src/utils/fileValidation.ts"
      via: "verifies magic bytes before extraction"
      pattern: "verifyFileMimeType"
    - from: "packages/server/src/index.ts"
      to: "packages/server/src/routes/upload.ts"
      via: "app.use('/api', uploadRouter)"
      pattern: "uploadRouter"
---

<objective>
Server-side upload infrastructure with defense-in-depth security validation.

Purpose: Build the backend foundation for secure ZIP file uploads with isolated project directories. This is the security-critical layer that validates files through multiple checks (multer MIME filter, magic bytes verification, pompelmi ZIP bomb/traversal/symlink detection) before extracting into UUID-isolated project directories.

Output: Working POST /api/upload endpoint that accepts ZIP files, validates them through multer + magic bytes + pompelmi pipeline, extracts into UUID-based project directories, and returns projectId. Shared upload types for client consumption.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-file-upload-validation/02-RESEARCH.md

@packages/server/src/index.ts
@packages/server/src/types/errors.ts
@packages/server/src/middleware/errorHandler.ts
@packages/server/src/routes/health.ts
@packages/server/src/config/env.ts
@packages/server/package.json
@packages/shared/src/types/api.ts
@packages/shared/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shared upload types, project service, and security utilities</name>
  <files>
    packages/shared/src/types/upload.ts
    packages/shared/src/types/index.ts
    packages/server/src/services/projectService.ts
    packages/server/src/utils/pathSecurity.ts
    packages/server/src/utils/fileValidation.ts
    packages/server/src/config/env.ts
    packages/server/package.json
    packages/server/src/__tests__/projectService.test.ts
    packages/server/src/__tests__/pathSecurity.test.ts
    packages/server/src/__tests__/fileValidation.test.ts
  </files>
  <action>
    **1. Shared upload types** (`packages/shared/src/types/upload.ts`):
    - Export `MAX_UPLOAD_SIZE = 100 * 1024 * 1024` (100MB) as const
    - Export `ALLOWED_MIME_TYPES = ['application/zip', 'application/x-zip-compressed'] as const`
    - Export `UploadResponse` interface: `{ projectId: string; message: string; fileCount: number }`
    - Export `UploadConfig` interface: `{ maxSize: number; allowedTypes: readonly string[] }`
    - Re-export from `packages/shared/src/types/index.ts`

    **2. Install server dependencies:**
    ```bash
    npm install --workspace @repo/server multer pompelmi uuid file-type
    npm install --workspace @repo/server -D @types/multer @types/uuid
    ```
    Note: `pompelmi` may not exist as an npm package (research suggested it). If it does not exist, use `yauzl` for ZIP extraction with manual security validation (compression ratio check, entry count limit, path traversal check, symlink check). Do NOT let a missing library block progress - implement the security checks manually using `yauzl` or Node.js built-in `zlib` + `yauzl`.

    **3. Update env config** (`packages/server/src/config/env.ts`):
    - Add `uploadDir` field: `process.env.UPLOAD_DIR || './uploads'`
    - Add `maxUploadSize` field: import MAX_UPLOAD_SIZE from shared, use as default

    **4. Project service** (`packages/server/src/services/projectService.ts`):
    - Class `ProjectService` with constructor accepting `baseDir: string`
    - `async createProjectDir(): Promise<{ projectId: string; projectPath: string }>` - generates UUID v4, creates directory under baseDir, returns both ID and path
    - `async cleanupProjectDir(projectId: string): Promise<void>` - validates path is within baseDir using `validatePathSafety`, then recursively removes directory
    - `async getProjectPath(projectId: string): Promise<string>` - resolves and validates project path
    - Ensure baseDir exists on construction (create if missing with `mkdir -p`)
    - Use `path.join` and `fs.realpath` for all path operations

    **5. Path security utilities** (`packages/server/src/utils/pathSecurity.ts`):
    - Export `async validatePathSafety(baseDir: string, targetPath: string): Promise<void>` - resolves both to absolute canonical paths, checks `targetPath.startsWith(baseDir + path.sep)`, throws `UserError` on violation
    - Export `async checkForSymlinks(filePath: string): Promise<void>` - uses `lstat` to detect symlinks, throws `UserError` if found
    - Export `validateZipEntryPath(entryPath: string): void` - synchronous check for `..` components, null bytes, absolute paths. Throws `UserError` on violation

    **6. File validation utilities** (`packages/server/src/utils/fileValidation.ts`):
    - Export `async verifyFileMimeType(buffer: Buffer, expectedMime: string): Promise<void>` - uses `file-type` library's `fileTypeFromBuffer` to read magic bytes, throws `UserError` if mismatch or undetectable
    - Handle the case where file-type returns undefined (unknown format)

    **7. Tests (TDD-style, write tests first):**
    - `projectService.test.ts`: Test createProjectDir returns valid UUID path, cleanupProjectDir removes directory, cleanupProjectDir rejects path traversal attempts, getProjectPath validates within baseDir
    - `pathSecurity.test.ts`: Test validatePathSafety rejects `../` traversal, accepts valid subpaths, rejects absolute paths outside base. Test checkForSymlinks rejects symlinks. Test validateZipEntryPath rejects `..`, null bytes, absolute paths
    - `fileValidation.test.ts`: Test verifyFileMimeType accepts valid ZIP buffer (create minimal ZIP with magic bytes PK\x03\x04), rejects non-ZIP buffers, rejects empty buffers

    Use the existing error classes from `packages/server/src/types/errors.ts` (UserError for validation failures).
  </action>
  <verify>
    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/languages-web-portal
    npm run build
    npm test -w @repo/server
    ```
    All new tests pass. Build succeeds with no TypeScript errors. Shared types are importable from @repo/shared.
  </verify>
  <done>
    ProjectService creates/cleans UUID-based directories. Path security utilities reject traversal/symlinks. File validation detects real MIME type via magic bytes. All unit tests pass. Shared upload types exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upload middleware, ZIP extraction, and upload route</name>
  <files>
    packages/server/src/middleware/fileUpload.ts
    packages/server/src/middleware/zipValidation.ts
    packages/server/src/routes/upload.ts
    packages/server/src/index.ts
    packages/server/src/__tests__/upload.test.ts
  </files>
  <action>
    **1. Multer upload middleware** (`packages/server/src/middleware/fileUpload.ts`):
    - Configure multer with `memoryStorage()` (buffer stays in memory for validation before disk write)
    - Set `limits.fileSize` to `MAX_UPLOAD_SIZE` from shared types
    - Set `limits.files` to 1
    - Add `fileFilter` that accepts `application/zip` and `application/x-zip-compressed` MIME types
    - Export configured `upload.single('file')` middleware as `uploadMiddleware`
    - Handle multer errors (MulterError for file size, file count) by converting to UserError with clear messages

    **2. ZIP validation middleware** (`packages/server/src/middleware/zipValidation.ts`):
    - If `pompelmi` is installed and works: configure with `maxEntries: 1000`, `maxEntrySize: 50MB`, `maxTotalSize: 500MB`, `maxNesting: 1`, `compressionRatio: 100`
    - If `pompelmi` is NOT available: create custom middleware that:
      - Uses `yauzl` (or Node.js `zlib`) to open the ZIP from buffer
      - Iterates entries and checks: entry count <= 1000, each entry uncompressed size <= 50MB, total uncompressed size <= 500MB, no nested ZIP files, compression ratio <= 100:1
      - Uses `validateZipEntryPath` from pathSecurity for each entry name
      - Throws `UserError` with descriptive message for any violation
    - Export as `zipValidator` middleware function
    - The middleware must also handle actual extraction: after validation passes, extract ZIP contents into the project directory (stored on `req` via a custom property or `res.locals`)

    **3. Upload route** (`packages/server/src/routes/upload.ts`):
    - `POST /upload` route with middleware chain: `uploadMiddleware` -> magic bytes verification -> `zipValidator` -> handler
    - In the handler:
      1. Verify file exists on req (`req.file`)
      2. Call `verifyFileMimeType(req.file.buffer, 'application/zip')` for magic bytes check
      3. Create project directory via `ProjectService.createProjectDir()`
      4. Extract ZIP into project directory (use `yauzl` to read from buffer, write entries to project dir, validate each entry path with `validateZipEntryPath` and `checkForSymlinks`)
      5. Count extracted files
      6. Return `UploadResponse` with `{ projectId, message: 'Upload successful', fileCount }`
    - Handle errors: multer errors -> 400, validation errors -> 422, ZIP security errors -> 400 with specific message
    - Use existing error classes (UserError, ValidationError)

    **4. Register upload router** (`packages/server/src/index.ts`):
    - Import uploadRouter from `./routes/upload.js`
    - Add `app.use('/api', uploadRouter)` AFTER healthRouter (order: health, upload, then Vite/static middleware)

    **5. Integration tests** (`packages/server/src/__tests__/upload.test.ts`):
    - Use supertest to test `POST /api/upload`
    - Test with valid ZIP file (create minimal valid ZIP buffer in test setup using `archiver` or manually construct ZIP bytes)
    - Test rejection of non-ZIP file (send a PNG/text buffer)
    - Test rejection of oversized file (mock or use multer limits)
    - Test rejection of missing file (no file attached)
    - Test that response contains valid projectId (UUID format)
    - Test that extracted files exist in the project directory
    - Clean up test directories after each test

    For creating test ZIP files: use the `archiver` npm package (`npm install -D --workspace @repo/server archiver @types/archiver`) to programmatically create valid ZIP buffers in tests. This is the standard approach for testing ZIP upload endpoints.
  </action>
  <verify>
    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/languages-web-portal
    npm run build
    npm test -w @repo/server
    npx eslint packages/server/src/ packages/shared/src/
    ```
    All tests pass (both new upload tests and existing health/error tests). Build succeeds. Linter passes. POST /api/upload responds correctly.
  </verify>
  <done>
    POST /api/upload accepts ZIP files, validates through multer (size/type) -> magic bytes (file-type) -> ZIP security (bomb/traversal/symlink detection), extracts into UUID-based project directory, returns `{ projectId, message, fileCount }`. Rejects malicious/invalid files with clear 4xx error messages. Integration tests verify the full pipeline.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no TypeScript errors across all packages
2. `npm test -w @repo/server` passes all tests (existing + new)
3. `curl -X POST http://localhost:3000/api/upload -F "file=@test.zip"` returns 200 with `{ projectId, message, fileCount }`
4. `curl -X POST http://localhost:3000/api/upload -F "file=@notazip.txt"` returns 4xx with error message
5. `curl -X POST http://localhost:3000/api/upload` (no file) returns 400
6. Uploaded ZIP contents appear in `uploads/{uuid}/` directory
7. Path traversal entries in ZIP are rejected (not extracted)
</verification>

<success_criteria>
- POST /api/upload endpoint accepts valid ZIP files and returns projectId
- Server validates MIME type via magic bytes (not just content-type header)
- Server detects and rejects zip bombs (compression ratio > 100:1)
- Server detects and rejects path traversal entries in ZIP
- Server detects and rejects symlinks in ZIP entries
- Each upload gets isolated UUID-based directory
- All server tests pass (10+ new tests covering security cases)
- Shared upload types (UploadResponse, MAX_UPLOAD_SIZE) available to client
</success_criteria>

<output>
After completion, create `.planning/phases/02-file-upload-validation/02-01-SUMMARY.md`
</output>
