---
phase: 02-file-upload-validation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - packages/server/src/services/exampleService.ts
  - packages/server/src/routes/examples.ts
  - packages/server/src/index.ts
  - packages/server/examples/cpp-to-c-transpiler/hello-world/main.cpp
  - packages/server/examples/cpp-to-c-transpiler/fibonacci/main.cpp
  - packages/server/examples/cpp-to-c-transpiler/linked-list/main.cpp
  - packages/server/examples/csharp-verification/null-check/Program.cs
  - packages/server/examples/csharp-verification/array-bounds/Program.cs
  - packages/server/examples/csharp-verification/division-safety/Program.cs
  - packages/client/src/features/upload/uploadApi.ts
  - packages/client/src/features/upload/UploadZone.tsx
  - packages/client/src/features/upload/types.ts
  - packages/client/src/store/index.ts
  - packages/client/src/pages/Home.tsx
  - packages/client/package.json
  - packages/server/src/__tests__/examples.test.ts
  - packages/client/src/__tests__/UploadZone.test.tsx
autonomous: true

must_haves:
  truths:
    - "User can upload ZIP file via drag-and-drop or file picker in browser"
    - "User sees maximum upload size limit (100MB) displayed before attempting upload"
    - "Browser validates file type (.zip only) and size before sending to server"
    - "User can load pre-built example projects with one click"
    - "Upload progress/status is visible (uploading, success, error states)"
  artifacts:
    - path: "packages/client/src/features/upload/UploadZone.tsx"
      provides: "Drag-and-drop file upload component with validation UI"
      min_lines: 60
    - path: "packages/client/src/features/upload/uploadApi.ts"
      provides: "RTK Query mutations for file upload and example loading"
      exports: ["uploadApi", "useUploadFileMutation", "useGetExamplesQuery", "useLoadExampleMutation"]
    - path: "packages/server/src/services/exampleService.ts"
      provides: "Pre-built example project listing and loading"
      exports: ["ExampleService"]
    - path: "packages/server/src/routes/examples.ts"
      provides: "GET /api/examples/:toolId and POST /api/examples/:toolId/:exampleName endpoints"
      exports: ["default (Router)"]
    - path: "packages/server/examples/"
      provides: "Pre-built example projects for at least 2 tools (3 examples each)"
  key_links:
    - from: "packages/client/src/features/upload/UploadZone.tsx"
      to: "packages/client/src/features/upload/uploadApi.ts"
      via: "useUploadFileMutation hook"
      pattern: "useUploadFileMutation"
    - from: "packages/client/src/features/upload/uploadApi.ts"
      to: "/api/upload"
      via: "RTK Query mutation with FormData"
      pattern: "FormData.*file"
    - from: "packages/client/src/features/upload/uploadApi.ts"
      to: "/api/examples"
      via: "RTK Query query and mutation"
      pattern: "examples"
    - from: "packages/server/src/routes/examples.ts"
      to: "packages/server/src/services/exampleService.ts"
      via: "loads example into project directory"
      pattern: "exampleService\\.loadExample"
    - from: "packages/client/src/store/index.ts"
      to: "packages/client/src/features/upload/uploadApi.ts"
      via: "uploadApi reducer and middleware registration"
      pattern: "uploadApi"
---

<objective>
Client-side upload UI with drag-and-drop and pre-built example project loading.

Purpose: Give users a polished file upload experience with immediate client-side feedback (file type/size validation, drag-and-drop, progress states) and the ability to try tools instantly via pre-built example projects. This completes the full upload flow from browser to server.

Output: UploadZone React component with react-dropzone, RTK Query upload/example API, server-side example service with sample projects for 2 tools, and full integration into the existing page layout.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-file-upload-validation/02-RESEARCH.md
@.planning/phases/02-file-upload-validation/02-01-SUMMARY.md

@packages/client/src/App.tsx
@packages/client/src/pages/Home.tsx
@packages/client/src/store/index.ts
@packages/client/src/features/health/api.ts
@packages/client/package.json
@packages/shared/src/types/upload.ts
@packages/shared/src/types/api.ts
@packages/shared/src/constants/tools.ts
@packages/server/src/index.ts
@packages/server/src/services/projectService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Example service, example data, and examples API route</name>
  <files>
    packages/server/src/services/exampleService.ts
    packages/server/src/routes/examples.ts
    packages/server/src/index.ts
    packages/server/examples/cpp-to-c-transpiler/hello-world/main.cpp
    packages/server/examples/cpp-to-c-transpiler/fibonacci/main.cpp
    packages/server/examples/cpp-to-c-transpiler/linked-list/main.cpp
    packages/server/examples/csharp-verification/null-check/Program.cs
    packages/server/examples/csharp-verification/array-bounds/Program.cs
    packages/server/examples/csharp-verification/division-safety/Program.cs
    packages/server/src/__tests__/examples.test.ts
  </files>
  <action>
    **1. Create example project files** in `packages/server/examples/`:
    - Structure: `examples/{tool-id}/{example-name}/` with source files inside
    - Create examples for 2 tools (the "available" ones from TOOLS constant):

    **cpp-to-c-transpiler** (3 examples):
    - `hello-world/main.cpp` - Simple hello world with iostream, classes, and RAII
    - `fibonacci/main.cpp` - Fibonacci with templates and constexpr
    - `linked-list/main.cpp` - Simple linked list with unique_ptr, demonstrating memory management

    **csharp-verification** (3 examples):
    - `null-check/Program.cs` - Class with nullable reference handling, null guard patterns
    - `array-bounds/Program.cs` - Array operations with bounds checking
    - `division-safety/Program.cs` - Division operations with zero-check contracts

    Each example should be small (20-50 lines), realistic, and demonstrate what the tool would analyze. Include a `README.md` in each example directory with a brief description (1-2 sentences) of what the example demonstrates.

    **2. Example service** (`packages/server/src/services/exampleService.ts`):
    - Class `ExampleService` with constructor accepting `examplesDir: string` (default: resolve to `packages/server/examples`)
    - `async getToolExamples(toolId: string): Promise<ExampleInfo[]>` - reads subdirectories of `{examplesDir}/{toolId}/`, returns array of `{ name: string; description: string }` (description from README.md if exists, else name)
    - `async loadExample(toolId: string, exampleName: string, targetDir: string): Promise<number>` - validates toolId and exampleName exist, copies recursively to targetDir, returns file count
    - Validate toolId against TOOLS constant from @repo/shared (reject unknown tools)
    - Validate exampleName exists (reject path traversal attempts)
    - Use `fs.cp(source, target, { recursive: true })` for copying

    **3. Add shared types** for examples to `packages/shared/src/types/upload.ts`:
    - Export `ExampleInfo` interface: `{ name: string; description: string }`
    - Export `ExampleLoadResponse` interface: `{ projectId: string; message: string; fileCount: number; toolId: string; exampleName: string }`

    **4. Examples route** (`packages/server/src/routes/examples.ts`):
    - `GET /examples/:toolId` - returns list of available examples for a tool via `exampleService.getToolExamples(toolId)`. Returns `{ examples: ExampleInfo[] }`. Returns 404 if toolId not found in TOOLS.
    - `POST /examples/:toolId/:exampleName` - creates a new project directory via ProjectService, loads example into it via ExampleService, returns `ExampleLoadResponse`. Returns 404 if tool or example not found.
    - Use existing error classes (NotFoundError, UserError)

    **5. Register examples router** in `packages/server/src/index.ts`:
    - Import examplesRouter from `./routes/examples.js`
    - Add `app.use('/api', examplesRouter)` after uploadRouter

    **6. Tests** (`packages/server/src/__tests__/examples.test.ts`):
    - Test GET /api/examples/cpp-to-c-transpiler returns 3 examples
    - Test GET /api/examples/nonexistent-tool returns 404
    - Test POST /api/examples/cpp-to-c-transpiler/hello-world returns projectId and copies files
    - Test POST /api/examples/cpp-to-c-transpiler/nonexistent returns 404
    - Clean up created project directories after each test
  </action>
  <verify>
    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/languages-web-portal
    npm run build
    npm test -w @repo/server
    ```
    All tests pass. Example files exist on disk. GET /api/examples/:toolId returns example list. POST loads example into project directory.
  </verify>
  <done>
    Example projects exist for 2 tools (3 examples each). ExampleService lists and copies examples. GET/POST /api/examples endpoints work. Tests verify listing and loading. Example data is realistic and demonstrates tool capabilities.
  </done>
</task>

<task type="auto">
  <name>Task 2: Client upload UI with react-dropzone and RTK Query integration</name>
  <files>
    packages/client/src/features/upload/uploadApi.ts
    packages/client/src/features/upload/UploadZone.tsx
    packages/client/src/features/upload/types.ts
    packages/client/src/store/index.ts
    packages/client/src/pages/Home.tsx
    packages/client/package.json
    packages/client/src/__tests__/UploadZone.test.tsx
  </files>
  <action>
    **1. Install client dependency:**
    ```bash
    npm install --workspace @repo/client react-dropzone
    ```

    **2. Upload types** (`packages/client/src/features/upload/types.ts`):
    - Re-export relevant types from @repo/shared (UploadResponse, ExampleInfo, ExampleLoadResponse, MAX_UPLOAD_SIZE)
    - Export `UploadState` type: `'idle' | 'uploading' | 'success' | 'error'`

    **3. Upload API** (`packages/client/src/features/upload/uploadApi.ts`):
    - Create RTK Query API slice `uploadApi` with `fetchBaseQuery({ baseUrl: '/api' })`
    - `uploadFile` mutation: accepts `File`, creates `FormData`, POSTs to `/upload`. Do NOT set Content-Type header (browser sets multipart boundary automatically). Returns `UploadResponse`.
    - `getExamples` query: accepts `toolId: string`, GETs `/examples/${toolId}`, returns `{ examples: ExampleInfo[] }`
    - `loadExample` mutation: accepts `{ toolId: string; exampleName: string }`, POSTs to `/examples/${toolId}/${exampleName}`, returns `ExampleLoadResponse`
    - Export hooks: `useUploadFileMutation`, `useGetExamplesQuery`, `useLoadExampleMutation`

    **4. Register API in store** (`packages/client/src/store/index.ts`):
    - Import `uploadApi` from `@/features/upload/uploadApi`
    - Add `[uploadApi.reducerPath]: uploadApi.reducer` to reducer map
    - Add `uploadApi.middleware` to middleware chain (concat after healthApi.middleware)

    **5. UploadZone component** (`packages/client/src/features/upload/UploadZone.tsx`):
    - Use `react-dropzone` with `useDropzone` hook
    - Configure: `accept: { 'application/zip': ['.zip'] }`, `maxSize: MAX_UPLOAD_SIZE`, `multiple: false`
    - Display upload area with dashed border, drag-active state (highlight on drag over)
    - Show "Max file size: 100MB" text prominently (FILE-02)
    - Show "Only .zip files accepted" text (FILE-03)
    - Handle `onDrop`: call `useUploadFileMutation` with accepted file
    - Display states:
      - Idle: "Drag and drop a ZIP file here, or click to browse"
      - Drag active: "Drop your ZIP file here..."
      - Uploading: spinner/loading indicator with "Uploading..."
      - Success: green check with projectId displayed, "Upload successful - {fileCount} files extracted"
      - Error: red error message from server response (file too large, invalid type, ZIP security issue)
    - Handle `fileRejections` from dropzone: show "File too large (max 100MB)" or "Only ZIP files are accepted" based on rejection code
    - Use Tailwind classes for styling. Use existing shadcn/ui Button component if applicable.
    - Accept optional `onUploadSuccess` callback prop: `(projectId: string) => void`

    **6. Update Home page** (`packages/client/src/pages/Home.tsx`):
    - Import and render `UploadZone` component below existing content
    - Add a section heading "Upload Your Code" or similar
    - Keep existing health check display

    **7. Tests** (`packages/client/src/__tests__/UploadZone.test.tsx`):
    - Test that UploadZone renders with drop area text and max size info
    - Test that file rejection shows error for non-zip files (mock dropzone rejection)
    - Test that upload state changes are reflected in UI (use RTK Query mock or MSW)
    - Minimum 3 tests covering render, validation feedback, and upload trigger
  </action>
  <verify>
    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/languages-web-portal
    npm run build
    npm test -w @repo/client
    npm test -w @repo/server
    npx eslint packages/client/src/ packages/server/src/ packages/shared/src/
    ```
    All tests pass (client + server). Build succeeds. Linter passes. UploadZone renders with drag-and-drop area, max size display, and file type restriction.
  </verify>
  <done>
    UploadZone component renders with drag-and-drop area showing "Max 100MB, .zip only". Dropping/selecting a ZIP file triggers upload via RTK Query mutation. Upload states (idle, uploading, success, error) render correctly. Examples API integration allows loading pre-built projects. Store is configured with uploadApi. Home page displays the upload zone.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no TypeScript errors across all packages
2. `npm test` passes in both client and server workspaces
3. Start dev server (`npm run dev`), navigate to home page:
   - UploadZone visible with "Max 100MB" and ".zip only" displayed
   - Drag a ZIP file over the zone - drop area highlights
   - Drop a valid ZIP - upload succeeds, projectId shown
   - Drop a non-ZIP file - client-side error shown immediately
4. `curl GET /api/examples/cpp-to-c-transpiler` returns 3 examples
5. `curl POST /api/examples/cpp-to-c-transpiler/hello-world` creates project with example files
6. ESLint passes on all source files
</verification>

<success_criteria>
- UploadZone component renders with drag-and-drop area
- Max upload size (100MB) is displayed to user before upload
- Browser rejects non-ZIP files with clear error message (client-side validation)
- Browser rejects oversized files with clear error message (client-side validation)
- Successful upload shows projectId and file count
- Example projects are loadable via API (at least 2 tools, 3 examples each)
- RTK Query upload mutation sends FormData correctly
- All client and server tests pass
- ESLint passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-file-upload-validation/02-02-SUMMARY.md`
</output>
