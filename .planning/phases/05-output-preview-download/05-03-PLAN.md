---
phase: 05-output-preview-download
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - packages/client/src/features/execution/ExecutionPanel.tsx
  - packages/client/src/pages/Home.tsx
  - packages/server/src/routes/execute.ts
  - packages/client/src/__tests__/OutputPanel.test.tsx
  - packages/client/src/__tests__/FilePreview.test.tsx
  - packages/client/src/__tests__/FileTree.test.tsx
  - packages/client/src/__tests__/DownloadButton.test.tsx
autonomous: true

must_haves:
  truths:
    - "After execution completes, OutputPanel appears showing file tree and download button"
    - "User flow is: upload -> select tool -> run -> stream output -> browse results -> download"
    - "Cleanup is scheduled on the server after execution completes"
    - "Tests cover OutputPanel, FileTree, FilePreview, and DownloadButton components"
  artifacts:
    - path: "packages/client/src/features/execution/ExecutionPanel.tsx"
      provides: "OutputPanel integration after execution complete state"
      contains: "OutputPanel"
    - path: "packages/server/src/routes/execute.ts"
      provides: "Cleanup scheduling after job completion"
      contains: "cleanupService"
    - path: "packages/client/src/__tests__/OutputPanel.test.tsx"
      provides: "Tests for OutputPanel composition and state management"
    - path: "packages/client/src/__tests__/FilePreview.test.tsx"
      provides: "Tests for FilePreview syntax highlighting and edge cases"
  key_links:
    - from: "packages/client/src/features/execution/ExecutionPanel.tsx"
      to: "packages/client/src/features/output/OutputPanel.tsx"
      via: "Conditional render when executionState === 'complete' and executionResult?.status === 'completed'"
      pattern: "<OutputPanel"
    - from: "packages/server/src/routes/execute.ts"
      to: "packages/server/src/services/cleanupService.ts"
      via: "cleanupService.scheduleCleanup() in job completion handler"
      pattern: "cleanupService\\.scheduleCleanup"
---

<objective>
Integration and testing: wire OutputPanel into the execution flow (appears after successful execution), trigger server-side cleanup scheduling when jobs complete, and write comprehensive tests for all new client components.

Purpose: Connects the output UI components built in Plan 02 into the actual user workflow, adds server-side cleanup triggering, and ensures quality with thorough test coverage.
Output: Modified ExecutionPanel and execute route, plus 4 test files.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-output-preview-download/05-RESEARCH.md
@.planning/phases/05-output-preview-download/05-01-SUMMARY.md
@.planning/phases/05-output-preview-download/05-02-SUMMARY.md
@packages/client/src/features/execution/ExecutionPanel.tsx
@packages/client/src/features/output/OutputPanel.tsx
@packages/server/src/routes/execute.ts
@packages/server/src/services/cleanupService.ts
@packages/shared/src/types/tool.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire OutputPanel into ExecutionPanel and trigger server-side cleanup</name>
  <files>
    packages/client/src/features/execution/ExecutionPanel.tsx
    packages/client/src/pages/Home.tsx
    packages/server/src/routes/execute.ts
  </files>
  <action>
1. Modify `packages/client/src/features/execution/ExecutionPanel.tsx`:
   - Import `OutputPanel` from `@/features/output/OutputPanel`.
   - Import `Tool` type from `@repo/shared` (already imported via useGetToolsQuery, just need the type).
   - After the existing "Execution Results" section (the `executionState === 'complete'` block), add a new section:
     - Condition: `executionState === 'complete' && executionResult?.status === 'completed' && projectId`.
     - Render section header "Output Files" with `<h3>`.
     - Render `<OutputPanel projectId={projectId} toolCategory={selectedTool?.category} />`.
     - This appears BELOW the execution results (status badge, metrics, console output) so the user sees: execution summary first, then output files below.
   - The `handleReset` function should also clear the selected file by resetting execution state (this already happens via setExecutionState('idle')).

2. Modify `packages/client/src/pages/Home.tsx`:
   - No structural changes needed. The OutputPanel is rendered inside ExecutionPanel, not at the Home level.
   - HOWEVER, widen the main container from `max-w-2xl` to `max-w-5xl` to accommodate the two-column output layout.
   - Also change `text-center` to `text-center lg:text-left` on the outer div for better output panel alignment.

3. Modify `packages/server/src/routes/execute.ts`:
   - Import `cleanupService` from `../services/cleanupService.js`.
   - In the fire-and-forget job callback, AFTER `streamService.sendComplete(jobId, result)` succeeds:
     - Schedule cleanup: `cleanupService.scheduleCleanup(projectId, projectPath)`.
     - Use the default delay (10 minutes) from the cleanupService.
     - This ensures cleanup is scheduled even if the user closes the browser (server-side scheduling, not client-dependent).
   - Also schedule cleanup in the catch block (after `streamService.sendError`), so failed jobs also get cleaned up.
   - Log cleanup scheduling: `console.log(\`[execute] Scheduled cleanup for project \${projectId}\`);`

Run linting on modified files: `npx eslint packages/client/src/features/execution/ExecutionPanel.tsx packages/client/src/pages/Home.tsx packages/server/src/routes/execute.ts`
  </action>
  <verify>
    Run `cd /Users/alexanderfedin/Projects/hapyy/languages-web-portal && npm run build` to confirm everything compiles together.
  </verify>
  <done>
    - OutputPanel appears below execution results when tool completes successfully
    - Server schedules 10-minute cleanup for every completed/failed execution
    - Page layout accommodates wider output panel
    - Full user flow works: upload -> select tool -> run -> stream -> browse output -> download
  </done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive tests for OutputPanel, FileTree, FilePreview, and DownloadButton</name>
  <files>
    packages/client/src/__tests__/OutputPanel.test.tsx
    packages/client/src/__tests__/FilePreview.test.tsx
    packages/client/src/__tests__/FileTree.test.tsx
    packages/client/src/__tests__/DownloadButton.test.tsx
  </files>
  <action>
1. Create `packages/client/src/__tests__/OutputPanel.test.tsx`:
   - Mock `outputApi` hooks at module level (same pattern as ExecutionPanel tests).
   - Mock `useGetFileTreeQuery` to return test file tree data.
   - Test: renders loading state when file tree is loading.
   - Test: renders file tree when data is available.
   - Test: renders error message when file tree fetch fails.
   - Test: renders "Select a file to preview" placeholder when no file selected.
   - Test: renders download button with correct projectId.
   - Test: renders info bar about automatic cleanup.
   - Use Redux Provider wrapper with test store including outputApi reducer.

2. Create `packages/client/src/__tests__/FilePreview.test.tsx`:
   - Mock `useGetFilePreviewQuery` hook.
   - Test: renders loading spinner while fetching.
   - Test: renders syntax-highlighted content for text files.
   - Test: shows truncation banner when `truncated: true`.
   - Test: shows binary file message when `language: 'binary'`.
   - Test: shows error message on fetch failure.
   - Test: renders correct language badge.
   - Test: renders output type badge (e.g., "Transpiled Source" for code files with transpiler category).
   - Mock react-syntax-highlighter to avoid importing the full library in tests:
     ```
     vi.mock('react-syntax-highlighter/dist/esm/light', () => ({
       Light: ({ children, language }: { children: string; language: string }) =>
         <pre data-testid="syntax-highlighter" data-language={language}>{children}</pre>
     }));
     ```

3. Create `packages/client/src/__tests__/FileTree.test.tsx`:
   - Test: renders tree with files and directories.
   - Test: calls onSelectFile when file (not directory) is clicked.
   - Test: does NOT call onSelectFile when directory is clicked.
   - Test: shows file sizes next to file names.
   - Provide mock file tree data: root with 2 directories and 3 files.
   - Note: react-complex-tree uses ARIA roles - use `getByRole('tree')`, `getByRole('treeitem')` for queries.

4. Create `packages/client/src/__tests__/DownloadButton.test.tsx`:
   - Test: renders anchor tag with correct href (`/api/projects/{projectId}/download`).
   - Test: renders with download attribute.
   - Test: shows "Download Output (ZIP)" text.
   - Test: applies disabled styling when disabled prop is true.
   - Simplest test file of the four.

Run all tests: `cd /Users/alexanderfedin/Projects/hapyy/languages-web-portal && npm test`.
Run linting on test files: `npx eslint packages/client/src/__tests__/OutputPanel.test.tsx packages/client/src/__tests__/FilePreview.test.tsx packages/client/src/__tests__/FileTree.test.tsx packages/client/src/__tests__/DownloadButton.test.tsx`.
  </action>
  <verify>
    Run `cd /Users/alexanderfedin/Projects/hapyy/languages-web-portal && npm run build && npm test` to confirm all tests pass (existing + new). Run `npx eslint packages/client/src/ packages/server/src/` to confirm all linting passes.
  </verify>
  <done>
    - OutputPanel test covers loading, data display, error, and placeholder states
    - FilePreview test covers syntax highlighting, truncation, binary files, and output type badges
    - FileTree test covers rendering, file selection, and directory exclusion from selection
    - DownloadButton test covers anchor attributes and disabled state
    - All existing tests still pass (no regressions)
    - Full linting passes across client and server
  </done>
</task>

</tasks>

<verification>
- `npm run build` compiles without errors
- `npm test` shows all tests passing (existing + ~20 new client tests + new server tests from Plan 01)
- `npx eslint packages/client/src/ packages/server/src/ --ext .ts,.tsx` passes
- OutputPanel renders inside ExecutionPanel after successful execution
- Cleanup scheduled in execute route for both success and failure paths
</verification>

<success_criteria>
- Complete user flow works: upload -> run tool -> stream output -> browse file tree -> preview files -> download ZIP
- Output panel appears automatically after execution completes with status 'completed'
- Server schedules cleanup after every execution (success or failure)
- Comprehensive test suite covers all new components with ~20 new client tests
- No regressions in existing test suites
</success_criteria>

<output>
After completion, create `.planning/phases/05-output-preview-download/05-03-SUMMARY.md`
</output>
