---
phase: 05-output-preview-download
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/types/output.ts
  - packages/shared/src/types/index.ts
  - packages/server/src/services/outputService.ts
  - packages/server/src/services/downloadService.ts
  - packages/server/src/services/cleanupService.ts
  - packages/server/src/routes/output.ts
  - packages/server/src/index.ts
  - packages/server/src/__tests__/outputService.test.ts
  - packages/server/src/__tests__/downloadService.test.ts
  - packages/server/src/__tests__/cleanupService.test.ts
  - packages/server/src/__tests__/output.test.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/projects/:projectId/output returns file tree structure for a project's output directory"
    - "GET /api/projects/:projectId/preview/:filePath returns file content with truncation for large files"
    - "GET /api/projects/:projectId/download streams a ZIP of the project directory"
    - "Path traversal attacks on preview endpoint are blocked with 403"
    - "Files larger than 500KB are truncated with indicator in preview response"
    - "Binary files return metadata instead of content"
    - "Cleanup service schedules directory deletion after configurable delay"
    - "Cleanup service handles graceful shutdown (SIGTERM/SIGINT)"
  artifacts:
    - path: "packages/shared/src/types/output.ts"
      provides: "FileNode, FileTreeResponse, FilePreviewResponse types"
      exports: ["FileNode", "FileTreeResponse", "FilePreviewResponse"]
    - path: "packages/server/src/services/outputService.ts"
      provides: "File tree building, file content reading, path validation"
      exports: ["OutputService", "outputService"]
    - path: "packages/server/src/services/downloadService.ts"
      provides: "Streaming ZIP creation for project downloads"
      exports: ["DownloadService", "downloadService"]
    - path: "packages/server/src/services/cleanupService.ts"
      provides: "TTL-based project directory cleanup with graceful shutdown"
      exports: ["CleanupService", "cleanupService"]
    - path: "packages/server/src/routes/output.ts"
      provides: "GET /api/projects/:projectId/output, preview, download endpoints"
  key_links:
    - from: "packages/server/src/routes/output.ts"
      to: "packages/server/src/services/outputService.ts"
      via: "outputService.buildFileTree(), outputService.readFileContent()"
      pattern: "outputService\\."
    - from: "packages/server/src/routes/output.ts"
      to: "packages/server/src/services/downloadService.ts"
      via: "downloadService.streamZipDownload()"
      pattern: "downloadService\\.streamZipDownload"
    - from: "packages/server/src/routes/output.ts"
      to: "packages/server/src/services/projectService.ts"
      via: "projectService.getProjectPath() for path resolution"
      pattern: "getProjectService\\(\\)\\.getProjectPath"
---

<objective>
Server-side output infrastructure: shared types, output service (file tree building, file preview with truncation, path validation), download service (streaming ZIP via archiver), cleanup service (TTL-based directory deletion with graceful shutdown), and three API routes for browsing, previewing, and downloading output files.

Purpose: Provides the backend foundation for Phase 5's output preview and download features. All three API endpoints must be working and tested before client UI can be built.
Output: Three new services, one route file with three endpoints, shared types, and comprehensive tests.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-output-preview-download/05-RESEARCH.md
@packages/shared/src/types/index.ts
@packages/shared/src/types/execution.ts
@packages/server/src/services/projectService.ts
@packages/server/src/utils/pathSecurity.ts
@packages/server/src/routes/execute.ts
@packages/server/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shared output types, output service, download service, and cleanup service</name>
  <files>
    packages/shared/src/types/output.ts
    packages/shared/src/types/index.ts
    packages/server/src/services/outputService.ts
    packages/server/src/services/downloadService.ts
    packages/server/src/services/cleanupService.ts
  </files>
  <action>
1. Create `packages/shared/src/types/output.ts` with these types:
   - `FileNode`: `{ id: string; name: string; isDirectory: boolean; children?: string[]; path: string; size?: number; extension?: string; }`
   - `FileTreeResponse`: `{ tree: Record<string, FileNode>; rootId: string; }`
   - `FilePreviewResponse`: `{ content: string; fileName: string; filePath: string; language: string; size: number; truncated: boolean; }`
   - `OutputType`: `'source' | 'report' | 'log' | 'config' | 'unknown'` (for distinguishing transpiler output from verification output per OUT-04)
   - Helper function `classifyOutputType(filePath: string, toolCategory: 'transpiler' | 'verification' | 'linter'): OutputType` that maps file extensions to output types:
     - Transpiler tools: `.c`, `.h`, `.cpp`, `.rs` -> 'source'; `.log` -> 'log'; `.json`, `.yaml` -> 'config'
     - Verification tools: `.log`, `.txt`, `.md` -> 'report'; `.json` -> 'config'
     - Default: 'unknown'

2. Add `export * from './output.js';` to `packages/shared/src/types/index.ts`.

3. Create `packages/server/src/services/outputService.ts`:
   - Class `OutputService` with constructor taking no args (uses projectService for path resolution).
   - Method `buildFileTree(projectPath: string): Promise<FileTreeResponse>`:
     - Recursively traverse directory using `fs.readdir(path, { withFileTypes: true })`.
     - Build `Record<string, FileNode>` with 'root' as root node.
     - For files: include `size` from `fs.stat()` and `extension` from `path.extname()`.
     - Normalize paths with `/` separator for web compatibility.
     - Sort children: directories first, then alphabetically by name.
   - Method `readFileContent(projectPath: string, filePath: string): Promise<FilePreviewResponse>`:
     - Validate path using `validatePathSafety(projectPath, resolvedPath)` from existing `pathSecurity.ts` util.
     - Check file exists with `fs.stat()`.
     - If file size > 500KB (524288 bytes), read only first 500KB and set `truncated: true`.
     - Detect if binary by checking for null bytes in first 8192 bytes. If binary, return `{ content: '', fileName, filePath, language: 'binary', size, truncated: false }` (client will show "binary file" message).
     - Detect language from extension using simple mapping: `.ts` -> 'typescript', `.js` -> 'javascript', `.c` -> 'c', `.h` -> 'c', `.cpp` -> 'cpp', `.hpp` -> 'cpp', `.rs` -> 'rust', `.py` -> 'python', `.json` -> 'json', `.md` -> 'markdown', `.yaml`/`.yml` -> 'yaml', `.xml` -> 'xml', `.log`/`.txt` -> 'text', default -> 'text'.
     - Return `FilePreviewResponse` with all fields populated.
   - Export singleton: `export const outputService = new OutputService();`

4. Create `packages/server/src/services/downloadService.ts`:
   - Class `DownloadService`.
   - Method `streamZipDownload(projectPath: string, projectId: string, res: Response): Promise<void>`:
     - Create archiver instance: `archiver('zip', { zlib: { level: 6 } })`.
     - Set response headers: `res.attachment(\`${projectId}-output.zip\`)`.
     - Listen for `archive.on('error')` and call `res.status(500).end()`.
     - Pipe `archive.pipe(res)`.
     - Add directory: `archive.directory(projectPath, false)`.
     - Await `archive.finalize()`.
     - Log bytes streamed.
   - Import `archiver` (already installed from Phase 2).
   - Import `Response` type from 'express'.
   - Export singleton: `export const downloadService = new DownloadService();`

5. Create `packages/server/src/services/cleanupService.ts`:
   - Class `CleanupService`:
     - Private `timers: Map<string, NodeJS.Timeout>`.
     - Private `DEFAULT_DELAY_MS = 10 * 60 * 1000` (10 minutes).
     - Method `scheduleCleanup(projectId: string, projectPath: string, delayMs?: number): void`:
       - Cancel existing timer if one exists for this projectId.
       - Create `setTimeout` that calls `fs.rm(projectPath, { recursive: true, force: true })`.
       - On success: delete from map, log cleanup.
       - On error: log error but don't throw (cleanup is best-effort).
       - Store timer in map.
     - Method `cancelCleanup(projectId: string): void`: Clear timeout, delete from map.
     - Method `getScheduledCount(): number`: Return `timers.size`.
     - Method `isScheduled(projectId: string): boolean`: Return `timers.has(projectId)`.
     - Method `async shutdown(): Promise<void>`:
       - Log shutdown initiation.
       - For each timer: clearTimeout, delete from map.
       - Log completion. Does NOT run immediate cleanup (data might still be useful on restart).
   - Export singleton: `export const cleanupService = new CleanupService();`
   - Register `process.on('SIGTERM')` and `process.on('SIGINT')` to call `cleanupService.shutdown()` then `process.exit(0)`.
   - Do NOT register these handlers at module level if `process.env.NODE_ENV === 'test'` (prevents test runner interference).
  </action>
  <verify>
    Run `cd /Users/alexanderfedin/Projects/hapyy/languages-web-portal && npm run build` to confirm TypeScript compilation succeeds with new types and services.
  </verify>
  <done>
    - FileNode, FileTreeResponse, FilePreviewResponse, OutputType types exported from @repo/shared
    - OutputService builds recursive file tree and reads file content with path validation and truncation
    - DownloadService streams ZIP via archiver
    - CleanupService schedules TTL-based deletion with graceful shutdown
    - All three services compile without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: API routes and comprehensive tests for all services and routes</name>
  <files>
    packages/server/src/routes/output.ts
    packages/server/src/index.ts
    packages/server/src/__tests__/outputService.test.ts
    packages/server/src/__tests__/downloadService.test.ts
    packages/server/src/__tests__/cleanupService.test.ts
    packages/server/src/__tests__/output.test.ts
  </files>
  <action>
1. Create `packages/server/src/routes/output.ts` with three endpoints:
   - Use lazy `getProjectService()` pattern from execute.ts for test compatibility.

   **GET /projects/:projectId/output** (file tree):
   - Resolve project path via `getProjectService().getProjectPath(projectId)`.
   - Call `outputService.buildFileTree(projectPath)`.
   - Return `{ data: fileTreeResponse }`.
   - Handle ENOENT -> 404 "Project not found or no output available".

   **GET /projects/:projectId/preview/:filePath(*)** (file preview):
   - Note: Use `/:filePath(*)` to capture paths with slashes (e.g., `src/main.c`).
   - Resolve project path via `getProjectService().getProjectPath(projectId)`.
   - Call `outputService.readFileContent(projectPath, filePath)`.
   - Return `{ data: previewResponse }`.
   - Handle ENOENT -> 404 "File not found".
   - Handle UserError (path traversal) -> 403.

   **GET /projects/:projectId/download** (ZIP download):
   - Resolve project path via `getProjectService().getProjectPath(projectId)`.
   - Call `downloadService.streamZipDownload(projectPath, projectId, res)`.
   - Handle ENOENT -> 404 "Project not found".

2. Register in `packages/server/src/index.ts`:
   - Import: `import outputRouter from './routes/output.js';`
   - Add: `app.use('/api', outputRouter);` after the stream router line.

3. Create `packages/server/src/__tests__/outputService.test.ts`:
   - Create temp directory with test files (text file, binary file, large file >500KB, nested directory structure).
   - Test `buildFileTree()`:
     - Returns root node with correct children.
     - Directories have `isDirectory: true` and children array.
     - Files have `size` and `extension` populated.
     - Children sorted: directories first, then alphabetically.
   - Test `readFileContent()`:
     - Returns content for text files with correct language detection.
     - Truncates files larger than 500KB and sets `truncated: true`.
     - Detects binary files and returns `language: 'binary'` with empty content.
     - Throws on path traversal attempts (e.g., `../../etc/passwd`).
     - Throws on non-existent files.
   - Cleanup temp directories in afterEach/afterAll.

4. Create `packages/server/src/__tests__/downloadService.test.ts`:
   - Create temp directory with test files.
   - Test `streamZipDownload()`:
     - Mock Express Response object with writable stream.
     - Verify archive.pipe() is called.
     - Verify output is valid ZIP (use archiver to create, verify bytes > 0).

5. Create `packages/server/src/__tests__/cleanupService.test.ts`:
   - Test `scheduleCleanup()`:
     - Creates timer, `isScheduled()` returns true.
     - After delay, directory is deleted.
     - Use short delay (100ms) for testing.
   - Test `cancelCleanup()`:
     - Cancels timer, `isScheduled()` returns false.
     - Directory is NOT deleted after delay.
   - Test `scheduleCleanup()` re-scheduling:
     - Calling twice replaces previous timer.
   - Test `shutdown()`:
     - Clears all timers, `getScheduledCount()` returns 0.
   - Use `vi.useFakeTimers()` where appropriate for timer tests.

6. Create `packages/server/src/__tests__/output.test.ts`:
   - Use standalone Express app (same pattern as stream.test.ts) to avoid Vite middleware.
   - Test GET /api/projects/:projectId/output:
     - 200 with valid file tree for existing project.
     - 404 for non-existent project.
   - Test GET /api/projects/:projectId/preview/:filePath:
     - 200 with file content for valid path.
     - 403 for path traversal attempt.
     - 404 for non-existent file.
   - Test GET /api/projects/:projectId/download:
     - 200 with application/zip content-type for valid project.
     - 404 for non-existent project.
   - Create temp project directories in beforeAll, cleanup in afterAll.

Run linting with `npx eslint packages/server/src/services/outputService.ts packages/server/src/services/downloadService.ts packages/server/src/services/cleanupService.ts packages/server/src/routes/output.ts` after creating files.
  </action>
  <verify>
    Run `cd /Users/alexanderfedin/Projects/hapyy/languages-web-portal && npm run build && npm test` to confirm all tests pass (existing + new).
  </verify>
  <done>
    - Three API endpoints registered and working: GET /projects/:projectId/output, preview, download
    - Path traversal blocked with 403 on preview endpoint
    - ZIP download streams with correct content-type header
    - All new tests pass alongside existing 94 server + 33 client tests
    - ESLint passes on all new files
  </done>
</task>

</tasks>

<verification>
- `npm run build` compiles without errors
- `npm test` shows all tests passing (existing + new output/download/cleanup tests)
- `npx eslint packages/server/src/ --ext .ts` passes
- `curl http://localhost:3000/api/projects/test-id/output` returns 404 (project not found) confirming route is registered
</verification>

<success_criteria>
- Shared output types available from @repo/shared
- OutputService builds file tree and reads file content with security validation
- DownloadService streams ZIP archives via archiver
- CleanupService manages TTL-based directory cleanup with graceful shutdown
- Three API routes registered and responding correctly
- Comprehensive test coverage for all services and routes
</success_criteria>

<output>
After completion, create `.planning/phases/05-output-preview-download/05-01-SUMMARY.md`
</output>
