---
phase: 05-output-preview-download
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - packages/client/package.json
  - packages/client/src/utils/languageMap.ts
  - packages/client/src/features/output/outputApi.ts
  - packages/client/src/features/output/FileTree.tsx
  - packages/client/src/features/output/FilePreview.tsx
  - packages/client/src/features/output/DownloadButton.tsx
  - packages/client/src/features/output/OutputPanel.tsx
  - packages/client/src/store/index.ts
autonomous: true

must_haves:
  truths:
    - "User can browse output files via tree view after execution completes"
    - "User can click a file in the tree to see its content with syntax highlighting"
    - "User can download full output as ZIP with one click"
    - "Output preview distinguishes transpiler results (code files) from verification results (reports/logs)"
    - "Binary files show download-to-view message instead of garbled content"
    - "Large files show truncation indicator"
  artifacts:
    - path: "packages/client/src/utils/languageMap.ts"
      provides: "Extension to Prism language mapping and detection function"
      exports: ["extensionToLanguage", "detectLanguage"]
    - path: "packages/client/src/features/output/outputApi.ts"
      provides: "RTK Query endpoints for file tree, preview, and download"
      exports: ["outputApi", "useGetFileTreeQuery", "useGetFilePreviewQuery"]
    - path: "packages/client/src/features/output/FileTree.tsx"
      provides: "Tree view component for browsing output files"
      exports: ["FileTree"]
    - path: "packages/client/src/features/output/FilePreview.tsx"
      provides: "Syntax-highlighted file content viewer"
      exports: ["FilePreview"]
    - path: "packages/client/src/features/output/DownloadButton.tsx"
      provides: "Button to trigger ZIP download of full output"
      exports: ["DownloadButton"]
    - path: "packages/client/src/features/output/OutputPanel.tsx"
      provides: "Composite panel with file tree, preview, and download"
      exports: ["OutputPanel"]
  key_links:
    - from: "packages/client/src/features/output/OutputPanel.tsx"
      to: "packages/client/src/features/output/outputApi.ts"
      via: "useGetFileTreeQuery hook"
      pattern: "useGetFileTreeQuery"
    - from: "packages/client/src/features/output/FilePreview.tsx"
      to: "packages/client/src/features/output/outputApi.ts"
      via: "useGetFilePreviewQuery hook"
      pattern: "useGetFilePreviewQuery"
    - from: "packages/client/src/features/output/outputApi.ts"
      to: "/api/projects/:projectId/output"
      via: "RTK Query fetchBaseQuery"
      pattern: "projects/.*/(output|preview|download)"
    - from: "packages/client/src/store/index.ts"
      to: "packages/client/src/features/output/outputApi.ts"
      via: "Redux store registration"
      pattern: "outputApi\\.reducer"
---

<objective>
Client-side output UI components: language mapping utility, RTK Query API for output endpoints, FileTree (react-complex-tree), FilePreview (react-syntax-highlighter with light build), DownloadButton, and OutputPanel that composes them into a browsable, previewable, downloadable output experience.

Purpose: Delivers the user-facing output browsing, preview, and download experience. After execution completes, users can explore output files in a tree, view syntax-highlighted content, and download everything as ZIP.
Output: Six new client files plus dependency installation and store registration.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-output-preview-download/05-RESEARCH.md
@.planning/phases/05-output-preview-download/05-01-SUMMARY.md
@packages/shared/src/types/output.ts
@packages/client/src/store/index.ts
@packages/client/src/features/execution/executionApi.ts
@packages/client/src/features/execution/ExecutionPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, create language map utility and RTK Query output API</name>
  <files>
    packages/client/package.json
    packages/client/src/utils/languageMap.ts
    packages/client/src/features/output/outputApi.ts
    packages/client/src/store/index.ts
  </files>
  <action>
1. Install client dependencies:
   ```bash
   cd packages/client && npm install react-syntax-highlighter react-complex-tree && npm install -D @types/react-syntax-highlighter
   ```

2. Create `packages/client/src/utils/languageMap.ts`:
   - Export `extensionToLanguage: Record<string, string>` mapping:
     - `.js`, `.jsx`, `.mjs`, `.cjs` -> 'javascript'
     - `.ts`, `.tsx` -> 'typescript'
     - `.py`, `.pyi` -> 'python'
     - `.c`, `.h` -> 'c'
     - `.cpp`, `.hpp`, `.cc`, `.cxx` -> 'cpp'
     - `.rs` -> 'rust'
     - `.cs` -> 'csharp'
     - `.java` -> 'java'
     - `.sh`, `.bash` -> 'bash'
     - `.json` -> 'json'
     - `.xml` -> 'xml'
     - `.yaml`, `.yml` -> 'yaml'
     - `.md` -> 'markdown'
     - `.txt`, `.log` -> 'text'
   - Export function `detectLanguage(filePath: string): string`:
     - Extract extension via `filePath.substring(filePath.lastIndexOf('.'))`.
     - Return `extensionToLanguage[ext.toLowerCase()] || 'text'`.
   - Export function `getOutputTypeLabel(language: string, toolCategory?: string): string`:
     - If toolCategory is 'transpiler' and language is a code language (c, cpp, rust, etc.) -> return 'Transpiled Source'
     - If toolCategory is 'verification' and language is 'text' or 'markdown' -> return 'Verification Report'
     - If language is 'text' or 'markdown' -> return 'Report / Log'
     - Default -> return language label capitalized
     This function supports OUT-04 (distinguishing transpiler vs verification output).

3. Create `packages/client/src/features/output/outputApi.ts`:
   - Use `createApi` from RTK Query with `fetchBaseQuery({ baseUrl: '/api' })`.
   - `reducerPath: 'outputApi'`.
   - Endpoints:
     - `getFileTree: builder.query<{ data: FileTreeResponse }, string>`:
       - `query: (projectId) => \`/projects/\${projectId}/output\``
     - `getFilePreview: builder.query<{ data: FilePreviewResponse }, { projectId: string; filePath: string }>`:
       - `query: ({ projectId, filePath }) => \`/projects/\${projectId}/preview/\${encodeURIComponent(filePath)}\``
   - Export hooks: `useGetFileTreeQuery`, `useGetFilePreviewQuery`.
   - Import types from `@repo/shared`.
   - Note: Download is NOT an RTK Query endpoint - it's a direct `<a>` link download (simpler, no blob handling needed).

4. Register in `packages/client/src/store/index.ts`:
   - Import `outputApi` from `@/features/output/outputApi`.
   - Add `[outputApi.reducerPath]: outputApi.reducer` to reducer.
   - Add `outputApi.middleware` to middleware chain.
  </action>
  <verify>
    Run `cd /Users/alexanderfedin/Projects/hapyy/languages-web-portal && npm run build` to confirm TypeScript compiles with new API and store registration.
  </verify>
  <done>
    - react-syntax-highlighter and react-complex-tree installed
    - Language map utility provides extension detection for all relevant languages
    - Output RTK Query API registered in Redux store with file tree and preview endpoints
  </done>
</task>

<task type="auto">
  <name>Task 2: FileTree, FilePreview, DownloadButton, and OutputPanel components</name>
  <files>
    packages/client/src/features/output/FileTree.tsx
    packages/client/src/features/output/FilePreview.tsx
    packages/client/src/features/output/DownloadButton.tsx
    packages/client/src/features/output/OutputPanel.tsx
  </files>
  <action>
1. Create `packages/client/src/features/output/FileTree.tsx`:
   - Import `UncontrolledTreeEnvironment`, `Tree`, `StaticTreeDataProvider` from 'react-complex-tree'.
   - Import `'react-complex-tree/lib/style-modern.css'` for default styling.
   - Props: `{ fileTree: Record<string, FileNode>; onSelectFile: (node: FileNode) => void; }`.
   - Use `StaticTreeDataProvider` with the fileTree data (simpler than custom dataProvider for read-only trees).
   - Convert FileNode to TreeItem format: `{ index: node.id, data: node, children: node.children || [], isFolder: node.isDirectory, canMove: false, canRename: false }`.
   - On item selection (`onSelectItems`): if selected item is not a directory, call `onSelectFile(item.data)`.
   - Set `canDragAndDrop={false}`, `canDropOnFolder={false}`, `canReorderItems={false}` (read-only tree).
   - Style the tree container with a border, rounded corners, max-height 400px with overflow-auto, and padding.
   - Show file size in a muted color next to file names using `renderItemTitle` (format: "main.c (2.1 KB)").
   - Format file sizes: bytes < 1024 -> "N B", < 1MB -> "N.N KB", else -> "N.N MB".

2. Create `packages/client/src/features/output/FilePreview.tsx`:
   - Use react-syntax-highlighter light build (Prism backend) to minimize bundle size (~50KB vs 500KB+).
   - Import: `import { Light as SyntaxHighlighter } from 'react-syntax-highlighter/dist/esm/light'`.
   - Register languages that matter for Hapyy tools (per research):
     - javascript, typescript, python, c, cpp, rust, csharp, java, bash, json, yaml, xml, markdown
   - Import vscDarkPlus theme: `import { vscDarkPlus } from 'react-syntax-highlighter/dist/esm/styles/prism'`.
   - Props: `{ projectId: string; filePath: string; fileName: string; }`.
   - Use `useGetFilePreviewQuery({ projectId, filePath })` to fetch content.
   - Loading state: show skeleton/spinner.
   - Error state: show error message.
   - Binary file (language === 'binary'): show "Binary file - download the output ZIP to view this file" message with download icon.
   - Truncated file: show yellow banner at top "Preview truncated - file is {size} bytes (showing first 500 KB)".
   - Render SyntaxHighlighter with `showLineNumbers`, `wrapLines`, dark theme, custom style for margin/border-radius/font-size.
   - Header bar showing file name, language badge, and output type label (from `getOutputTypeLabel`).
   - The output type badge uses different colors: 'Transpiled Source' -> blue badge, 'Verification Report' -> green badge, 'Report / Log' -> gray badge. This fulfills OUT-04.

3. Create `packages/client/src/features/output/DownloadButton.tsx`:
   - Props: `{ projectId: string; disabled?: boolean; }`.
   - Render as an `<a>` tag styled as a Button (using shadcn Button with `asChild` or direct anchor styling).
   - href: `/api/projects/${projectId}/download`.
   - download attribute: `${projectId}-output.zip`.
   - Show download icon (use simple SVG or unicode arrow down).
   - Text: "Download Output (ZIP)".
   - disabled state: reduce opacity, pointer-events-none.

4. Create `packages/client/src/features/output/OutputPanel.tsx`:
   - Props: `{ projectId: string; toolCategory?: 'transpiler' | 'verification' | 'linter'; }`.
   - Use `useGetFileTreeQuery(projectId)` to load file tree on mount.
   - State: `selectedFile: FileNode | null` (initially null).
   - Layout: Two-column on lg+ screens (tree left 1/3, preview right 2/3), stacked on mobile.
   - Left column: FileTree component + DownloadButton at bottom.
   - Right column: FilePreview when a file is selected, or placeholder "Select a file to preview" message when none selected.
   - Loading state: show "Loading output files..." with spinner.
   - Error state: show "No output files available" or error message.
   - Empty state (tree loads but no files): show "No output files generated" message.
   - Pass `toolCategory` to FilePreview for output type labeling (OUT-04).
   - Add a small info bar at top: "Output available for download. Files will be cleaned up automatically." (informs user about cleanup per INFRA-02).

Run linting: `npx eslint packages/client/src/features/output/ packages/client/src/utils/languageMap.ts` after creating all files.
  </action>
  <verify>
    Run `cd /Users/alexanderfedin/Projects/hapyy/languages-web-portal && npm run build && npx eslint packages/client/src/features/output/ packages/client/src/utils/languageMap.ts` to confirm build and lint pass.
  </verify>
  <done>
    - FileTree renders interactive file tree with size annotations
    - FilePreview shows syntax-highlighted content with language detection, binary handling, and truncation indicator
    - DownloadButton provides direct ZIP download via anchor link
    - OutputPanel composes tree, preview, and download into a responsive two-column layout
    - Output type badges distinguish transpiler source from verification reports (OUT-04)
    - All files compile and lint clean
  </done>
</task>

</tasks>

<verification>
- `npm run build` compiles without errors
- `npx eslint packages/client/src/ --ext .ts,.tsx` passes
- New dependencies (react-syntax-highlighter, react-complex-tree) in package.json
- outputApi registered in Redux store
- All components export correctly and are importable
</verification>

<success_criteria>
- File tree renders with directory/file hierarchy from API response
- Clicking file in tree loads syntax-highlighted preview via RTK Query
- Download button provides direct ZIP download
- Binary files show helpful message instead of garbled content
- Large files show truncation indicator
- Output type badges distinguish transpiler vs verification output
- Responsive layout works on mobile (stacked) and desktop (side-by-side)
</success_criteria>

<output>
After completion, create `.planning/phases/05-output-preview-download/05-02-SUMMARY.md`
</output>
